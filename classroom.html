<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  >
  <title>教室 - 點名系統</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft JhengHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .classroom {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .classroom-name {
      font-size: 1.8em;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid #667eea;
    }

    .students-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 10px;
    }

    .student-card {
      background: #f5f5f5;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      font-size: 1em;
      font-weight: 500;
      color: #333;
      transition: all 0.3s ease;
      position: relative;
      user-select: none;
    }

    .student-card.present {
      background: #4CAF50;
      color: white;
      border-color: #45a049;
      cursor: pointer;
    }

    .student-card.present:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .student-card.present::after {
      content: '可以準備下樓';
      display: block;
      font-size: 0.75em;
      margin-top: 5px;
      opacity: 0.9;
    }

    .student-card.left {
      background: #e53935;
      color: white;
      border-color: #c62828;
      cursor: pointer;
    }

    .student-card.left:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      background: #ef9a9a;
      border-color: #e57373;
    }

    .student-card.left::after {
      content: '已離開教室';
      display: block;
      font-size: 0.75em;
      margin-top: 5px;
      opacity: 0.9;
    }

    .student-card.left:hover::after {
      content: '點擊返回教室';
    }

    @media (max-width: 1024px) {
      .students-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (max-width: 768px) {
      .students-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #4CAF50;
      margin-left: 10px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .not-found {
      text-align: center;
      color: white;
      font-size: 1.5em;
      margin-top: 100px;
    }

    .back-link {
      display: inline-block;
      margin-top: 20px;
      padding: 10px 20px;
      background: white;
      color: #667eea;
      text-decoration: none;
      border-radius: 20px;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 id="page-title">教室 <span class="status-indicator"></span></h1>
    <div id="classroom-container"></div>
    <div
      id="not-found"
      class="not-found"
      style="display: none;"
    >
      找不到此教室
      <br>
      <a
        href="/"
        class="back-link"
      >回到首頁</a>
    </div>
  </div>

  <script>
    let ws;
    let currentClassroom = null;
    const classroomContainer = document.getElementById('classroom-container');
    const notFound = document.getElementById('not-found');
    const pageTitle = document.getElementById('page-title');

    // 音效功能
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    function playNotificationSound() {
      // 播放歡快的三連音
      const notes = [
        { freq: 523.25, time: 0, duration: 0.15 },      // C5
        { freq: 659.25, time: 0.15, duration: 0.15 },   // E5
        { freq: 783.99, time: 0.3, duration: 0.25 }     // G5
      ];

      notes.forEach(note => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = note.freq;
        oscillator.type = 'sine';

        const startTime = audioContext.currentTime + note.time;
        const endTime = startTime + note.duration;

        gainNode.gain.setValueAtTime(0.4, startTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, endTime);

        oscillator.start(startTime);
        oscillator.stop(endTime);
      });
    }

    // 從 URL 取得教室路徑
    const classroomPath = window.location.pathname.substring(1);

    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

      ws.onopen = () => {
        console.log('WebSocket 連線成功');
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'init') {
          findAndRenderClassroom(data.classrooms);
        } else if (data.type === 'classroom_added') {
          if (data.classroom.path === classroomPath) {
            renderClassroom(data.classroom);
          }
        } else if (data.type === 'classroom_updated') {
          if (data.classroom.id === currentClassroom?.id) {
            renderClassroom(data.classroom);
          }
        } else if (data.type === 'classroom_deleted') {
          if (data.classroomId === currentClassroom?.id) {
            showNotFound();
          }
        } else if (data.type === 'student_updated') {
          if (data.classroomId === currentClassroom?.id) {
            updateStudent(data.studentIndex, data.present, data.left);
          }
        } else if (data.type === 'classroom_cleared') {
          if (data.classroomId === currentClassroom?.id) {
            clearAllStudentCards();
          }
        }
      };

      ws.onclose = () => {
        console.log('WebSocket 連線關閉，3秒後重新連線...');
        setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = (error) => {
        console.error('WebSocket 錯誤:', error);
      };
    }

    function findAndRenderClassroom(classrooms) {
      const classroom = classrooms.find(c => c.path === classroomPath);

      if (classroom) {
        renderClassroom(classroom);
      } else {
        showNotFound();
      }
    }

    function renderClassroom(classroom) {
      currentClassroom = classroom;
      notFound.style.display = 'none';
      classroomContainer.style.display = 'block';

      pageTitle.innerHTML = `${classroom.name} <span class="status-indicator"></span>`;
      document.title = `${classroom.name} - 點名系統`;

      classroomContainer.innerHTML = '';

      const classroomDiv = document.createElement('div');
      classroomDiv.className = 'classroom';

      const nameDiv = document.createElement('div');
      nameDiv.className = 'classroom-name';
      nameDiv.textContent = classroom.name;

      const gridDiv = document.createElement('div');
      gridDiv.className = 'students-grid';

      classroom.students.forEach((student, index) => {
        const studentCard = document.createElement('div');
        const statusClass = student.left ? 'left' : (student.present ? 'present' : '');
        studentCard.className = `student-card ${statusClass}`;
        studentCard.textContent = student.name;
        studentCard.dataset.studentIndex = index;

        // 添加點擊事件：綠色可標記已離開，紅色可返回教室
        studentCard.addEventListener('click', function () {
          // 從當前 DOM 狀態判斷
          const isCurrentlyLeft = this.classList.contains('left');
          const isCurrentlyPresent = this.classList.contains('present');

          if (isCurrentlyPresent || isCurrentlyLeft) {
            toggleStudentLeftStatus(index, isCurrentlyLeft);
          }
        });

        gridDiv.appendChild(studentCard);
      });

      classroomDiv.appendChild(nameDiv);
      classroomDiv.appendChild(gridDiv);
      classroomContainer.appendChild(classroomDiv);
    }

    function updateStudent(studentIndex, present, left) {
      const card = document.querySelector(`[data-student-index="${studentIndex}"]`);

      if (card) {
        const wasPresent = card.classList.contains('present');

        // 移除所有狀態
        card.classList.remove('present', 'left');

        // 設置新狀態
        if (left) {
          card.classList.add('left');
        } else if (present) {
          card.classList.add('present');
          // 如果是從不在場變為在場，播放音效
          if (!wasPresent) {
            playNotificationSound();
          }
        }
      }
    }

    function clearAllStudentCards() {
      const cards = document.querySelectorAll('[data-student-index]');
      cards.forEach(card => {
        card.classList.remove('present', 'left');
      });
    }

    function showNotFound() {
      classroomContainer.style.display = 'none';
      notFound.style.display = 'block';
    }

    function toggleStudentLeftStatus(studentIndex, isCurrentlyLeft) {
      if (!currentClassroom) return;

      fetch(`/api/classrooms/${currentClassroom.id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          studentIndex: studentIndex,
          left: !isCurrentlyLeft
        })
      }).catch(error => {
        console.error('更新學生狀態失敗:', error);
      });
    }

    // 初始化
    connectWebSocket();
  </script>
</body>

</html>