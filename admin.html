<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  >
  <title>é»åç³»çµ± - ç®¡ç†å“¡</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft JhengHei', sans-serif;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header-actions {
      text-align: center;
      margin-bottom: 30px;
    }

    .btn {
      background: white;
      color: #f5576c;
      border: none;
      padding: 15px 30px;
      font-size: 1.1em;
      font-weight: bold;
      border-radius: 25px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }

    .classroom {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .classroom-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid #f5576c;
    }

    .classroom-name {
      font-size: 1.8em;
      color: #333;
      margin: 0;
    }

    .classroom-actions {
      display: flex;
      gap: 10px;
    }

    .btn-small {
      padding: 8px 15px;
      font-size: 0.9em;
      border-radius: 15px;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #d32f2f;
    }

    .btn-edit {
      background: #2196F3;
      color: white;
    }

    .btn-edit:hover {
      background: #1976D2;
    }

    .btn-warning {
      background: #FF9800;
      color: white;
    }

    .btn-warning:hover {
      background: #F57C00;
    }

    .students-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 10px;
    }

    .student-card {
      background: #f5f5f5;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      font-size: 1em;
      font-weight: 500;
      color: #333;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      position: relative;
    }

    .student-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .student-card.present {
      background: #4CAF50;
      color: white;
      border-color: #45a049;
    }

    .student-card.left {
      background: #e53935;
      color: white;
      border-color: #c62828;
    }

    .student-card.left::after {
      content: 'å·²é›¢é–‹æ•™å®¤';
      display: block;
      font-size: 0.75em;
      margin-top: 5px;
      opacity: 0.9;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .modal-title {
      font-size: 1.8em;
      color: #333;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 1.1em;
      color: #555;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-input {
      width: 100%;
      padding: 12px;
      font-size: 1em;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: border-color 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: #f5576c;
    }

    textarea.form-input {
      min-height: 150px;
      resize: vertical;
      font-family: inherit;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn-secondary {
      background: #999;
      color: white;
    }

    .btn-secondary:hover {
      background: #777;
    }

    @media (max-width: 1024px) {
      .students-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (max-width: 768px) {
      .students-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .empty-state {
      text-align: center;
      color: white;
      font-size: 1.3em;
      margin-top: 50px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>é»åç³»çµ± - ç®¡ç†å“¡</h1>

    <div class="header-actions">
      <button
        class="btn"
        onclick="openAddClassroomModal()"
      >â• æ–°å¢æ•™å®¤</button>
    </div>

    <div id="classrooms-container"></div>
    <div
      id="empty-state"
      class="empty-state"
      style="display: none;"
    >
      ç›®å‰æ²’æœ‰ä»»ä½•ç­ç´šï¼Œé»æ“Šã€Œæ–°å¢æ•™å®¤ã€é–‹å§‹ä½¿ç”¨
    </div>
  </div>

  <!-- æ–°å¢æ•™å®¤ Modal -->
  <div
    id="addClassroomModal"
    class="modal"
  >
    <div class="modal-content">
      <h2 class="modal-title">æ–°å¢æ•™å®¤</h2>

      <div class="form-group">
        <label class="form-label">æ•™å®¤åç¨±</label>
        <input
          type="text"
          id="classroomName"
          class="form-input"
          placeholder="ä¾‹ï¼šè³‡å·¥ä¸€ç”²"
        >
      </div>

      <div class="form-group">
        <label class="form-label">æ•™å®¤ç¶²å€è·¯å¾‘</label>
        <input
          type="text"
          id="classroomPath"
          class="form-input"
          placeholder="ä¾‹ï¼šroblox (åƒ…é™è‹±æ•¸å­—ã€é€£å­—è™Ÿã€åº•ç·š)"
        >
        <div style="font-size: 0.9em; color: #999; margin-top: 5px;">
          ç¶²å€å°‡æœƒæ˜¯ï¼šhttp://localhost:8000/<span
            id="pathPreview"
            style="color: #f5576c; font-weight: bold;"
          >___</span>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">å­¸ç”Ÿåå–®ï¼ˆæ¯è¡Œä¸€å€‹å§“åï¼‰</label>
        <textarea
          id="studentNames"
          class="form-input"
          placeholder="å¼µä¸‰&#10;æå››&#10;ç‹äº”"
        ></textarea>
      </div>

      <div class="modal-actions">
        <button
          class="btn btn-secondary"
          onclick="closeAddClassroomModal()"
        >å–æ¶ˆ</button>
        <button
          class="btn"
          onclick="createClassroom()"
        >ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯æ•™å®¤ Modal -->
  <div
    id="editClassroomModal"
    class="modal"
  >
    <div class="modal-content">
      <h2 class="modal-title">ç·¨è¼¯æ•™å®¤</h2>

      <div class="form-group">
        <label class="form-label">æ•™å®¤åç¨±</label>
        <input
          type="text"
          id="editClassroomName"
          class="form-input"
          placeholder="ä¾‹ï¼šè³‡å·¥ä¸€ç”²"
        >
      </div>

      <div class="form-group">
        <label class="form-label">æ•™å®¤ç¶²å€è·¯å¾‘</label>
        <input
          type="text"
          id="editClassroomPath"
          class="form-input"
          placeholder="ä¾‹ï¼šroblox (åƒ…é™è‹±æ•¸å­—ã€é€£å­—è™Ÿã€åº•ç·š)"
        >
        <div style="font-size: 0.9em; color: #999; margin-top: 5px;">
          ç¶²å€å°‡æœƒæ˜¯ï¼šhttp://localhost:8000/<span
            id="editPathPreview"
            style="color: #f5576c; font-weight: bold;"
          >___</span>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">å­¸ç”Ÿåå–®ï¼ˆæ¯è¡Œä¸€å€‹å§“åï¼‰</label>
        <textarea
          id="editStudentNames"
          class="form-input"
          placeholder="å¼µä¸‰&#10;æå››&#10;ç‹äº”"
        ></textarea>
      </div>

      <div class="modal-actions">
        <button
          class="btn btn-secondary"
          onclick="closeEditClassroomModal()"
        >å–æ¶ˆ</button>
        <button
          class="btn"
          onclick="saveClassroom()"
        >ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <script>
    let ws;
    let editingClassroomId = null;
    const classroomsContainer = document.getElementById('classrooms-container');
    const emptyState = document.getElementById('empty-state');
    const STORAGE_KEY = 'attendance_classrooms';

    // LocalStorage æ“ä½œ
    function saveToLocalStorage(classrooms) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(classrooms));
      } catch (e) {
        console.error('ç„¡æ³•ä¿å­˜åˆ° localStorage:', e);
      }
    }

    function loadFromLocalStorage() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : [];
      } catch (e) {
        console.error('ç„¡æ³•å¾ localStorage è®€å–:', e);
        return [];
      }
    }

    // åŒæ­¥ localStorage è³‡æ–™åˆ°ä¼ºæœå™¨
    async function syncToServer() {
      const classrooms = loadFromLocalStorage();
      if (classrooms.length > 0) {
        try {
          await fetch('/api/classrooms/sync', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ classrooms })
          });
          console.log('å·²åŒæ­¥', classrooms.length, 'å€‹æ•™å®¤åˆ°ä¼ºæœå™¨');
        } catch (error) {
          console.error('åŒæ­¥åˆ°ä¼ºæœå™¨å¤±æ•—:', error);
        }
      }
    }

    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

      ws.onopen = () => {
        console.log('WebSocket é€£ç·šæˆåŠŸ');
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'init') {
          renderClassrooms(data.classrooms);
          // ä¿å­˜åˆ° localStorage
          saveToLocalStorage(data.classrooms);
        } else if (data.type === 'classroom_added') {
          addClassroom(data.classroom);
          // æ›´æ–° localStorage
          const classrooms = loadFromLocalStorage();
          classrooms.push(data.classroom);
          saveToLocalStorage(classrooms);
        } else if (data.type === 'classroom_updated') {
          updateClassroom(data.classroom);
          // æ›´æ–° localStorage
          const classrooms = loadFromLocalStorage();
          const index = classrooms.findIndex(c => c.id === data.classroom.id);
          if (index !== -1) {
            classrooms[index] = data.classroom;
            saveToLocalStorage(classrooms);
          }
        } else if (data.type === 'classroom_deleted') {
          removeClassroom(data.classroomId);
          // æ›´æ–° localStorage
          const classrooms = loadFromLocalStorage();
          const filtered = classrooms.filter(c => c.id !== data.classroomId);
          saveToLocalStorage(filtered);
        } else if (data.type === 'student_updated') {
          updateStudent(data.classroomId, data.studentIndex, data.present, data.left);
          // æ›´æ–° localStorage
          const classrooms = loadFromLocalStorage();
          const classroom = classrooms.find(c => c.id === data.classroomId);
          if (classroom && classroom.students[data.studentIndex]) {
            classroom.students[data.studentIndex].present = data.present;
            classroom.students[data.studentIndex].left = data.left || false;
            saveToLocalStorage(classrooms);
          }
        } else if (data.type === 'classroom_cleared') {
          // æ¸…é™¤è©²æ•™å®¤æ‰€æœ‰å­¸ç”Ÿç‹€æ…‹
          clearAllStudentCards(data.classroomId);
          // æ›´æ–° localStorage
          const classrooms = loadFromLocalStorage();
          const classroom = classrooms.find(c => c.id === data.classroomId);
          if (classroom) {
            classroom.students.forEach(s => {
              s.present = false;
              s.left = false;
            });
            saveToLocalStorage(classrooms);
          }
        }
      };

      ws.onclose = () => {
        console.log('WebSocket é€£ç·šé—œé–‰ï¼Œ3ç§’å¾Œé‡æ–°é€£ç·š...');
        setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = (error) => {
        console.error('WebSocket éŒ¯èª¤:', error);
      };
    }

    function renderClassrooms(classrooms) {
      if (classrooms.length === 0) {
        classroomsContainer.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      classroomsContainer.innerHTML = '';

      classrooms.forEach(classroom => {
        addClassroom(classroom);
      });
    }

    function addClassroom(classroom) {
      emptyState.style.display = 'none';

      const classroomDiv = document.createElement('div');
      classroomDiv.className = 'classroom';
      classroomDiv.id = `classroom-${classroom.id}`;

      const headerDiv = document.createElement('div');
      headerDiv.className = 'classroom-header';

      const nameDiv = document.createElement('div');
      nameDiv.className = 'classroom-name';
      nameDiv.innerHTML = `${classroom.name} <a href="/${classroom.path}" target="_blank" style="font-size: 0.6em; color: #999; text-decoration: none; margin-left: 10px;">ğŸ”— /${classroom.path}</a>`;

      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'classroom-actions';

      const clearBtn = document.createElement('button');
      clearBtn.className = 'btn btn-small btn-warning';
      clearBtn.textContent = 'ğŸ”„ æ¸…é™¤ç‹€æ…‹';
      clearBtn.onclick = () => clearAllStatus(classroom.id, classroom.name);

      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-small btn-edit';
      editBtn.textContent = 'âœï¸ ç·¨è¼¯';
      editBtn.onclick = () => openEditClassroomModal(classroom);

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-small btn-danger';
      deleteBtn.textContent = 'ğŸ—‘ï¸ åˆªé™¤';
      deleteBtn.onclick = () => deleteClassroom(classroom.id);

      actionsDiv.appendChild(clearBtn);
      actionsDiv.appendChild(editBtn);
      actionsDiv.appendChild(deleteBtn);

      headerDiv.appendChild(nameDiv);
      headerDiv.appendChild(actionsDiv);

      const gridDiv = document.createElement('div');
      gridDiv.className = 'students-grid';

      classroom.students.forEach((student, index) => {
        const studentCard = document.createElement('div');
        const statusClass = student.left ? 'left' : (student.present ? 'present' : '');
        studentCard.className = `student-card ${statusClass}`;
        studentCard.textContent = student.name;
        studentCard.dataset.classroomId = classroom.id;
        studentCard.dataset.studentIndex = index;
        studentCard.onclick = () => toggleStudentPresence(classroom.id, index);
        gridDiv.appendChild(studentCard);
      });

      classroomDiv.appendChild(headerDiv);
      classroomDiv.appendChild(gridDiv);
      classroomsContainer.appendChild(classroomDiv);
    }

    function updateClassroom(classroom) {
      const classroomDiv = document.getElementById(`classroom-${classroom.id}`);
      if (classroomDiv) {
        classroomDiv.remove();
      }
      addClassroom(classroom);
    }

    function removeClassroom(classroomId) {
      const classroomDiv = document.getElementById(`classroom-${classroomId}`);
      if (classroomDiv) {
        classroomDiv.remove();
      }

      if (classroomsContainer.children.length === 0) {
        emptyState.style.display = 'block';
      }
    }

    function updateStudent(classroomId, studentIndex, present, left) {
      const card = document.querySelector(
        `[data-classroom-id="${classroomId}"][data-student-index="${studentIndex}"]`
      );

      if (card) {
        // ç§»é™¤æ‰€æœ‰ç‹€æ…‹
        card.classList.remove('present', 'left');

        // è¨­ç½®æ–°ç‹€æ…‹
        if (left) {
          card.classList.add('left');
        } else if (present) {
          card.classList.add('present');
        }
      }
    }

    function clearAllStudentCards(classroomId) {
      const cards = document.querySelectorAll(`[data-classroom-id="${classroomId}"]`);
      cards.forEach(card => {
        card.classList.remove('present', 'left');
      });
    }

    async function toggleStudentPresence(classroomId, studentIndex) {
      const card = document.querySelector(
        `[data-classroom-id="${classroomId}"][data-student-index="${studentIndex}"]`
      );

      const isPresent = card.classList.contains('present');
      const isLeft = card.classList.contains('left');

      // ç‹€æ…‹å¾ªç’°ï¼šç°è‰²ï¼ˆæœªåˆ°ï¼‰ -> ç¶ è‰²ï¼ˆå·²åˆ°ï¼‰ -> ç°è‰²ï¼ˆæœªåˆ°ï¼‰
      // æ³¨æ„ï¼šç´…è‰²ï¼ˆå·²é›¢é–‹ï¼‰ç‹€æ…‹åªèƒ½å¾ä½¿ç”¨è€…ç«¯è¨­ç½®
      const newPresent = !isPresent && !isLeft;

      try {
        const response = await fetch(`/api/classrooms/${classroomId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            studentIndex: studentIndex,
            present: newPresent
          })
        });

        if (!response.ok) {
          throw new Error('æ›´æ–°å¤±æ•—');
        }
      } catch (error) {
        console.error('æ›´æ–°å­¸ç”Ÿç‹€æ…‹å¤±æ•—:', error);
        alert('æ›´æ–°å¤±æ•—ï¼Œè«‹é‡è©¦');
      }
    }

    function openAddClassroomModal() {
      document.getElementById('addClassroomModal').classList.add('active');
      document.getElementById('classroomName').value = '';
      document.getElementById('classroomPath').value = '';
      document.getElementById('studentNames').value = '';
      updatePathPreview();
    }

    function closeAddClassroomModal() {
      document.getElementById('addClassroomModal').classList.remove('active');
    }

    function updatePathPreview() {
      const path = document.getElementById('classroomPath').value.trim();
      document.getElementById('pathPreview').textContent = path || '___';
    }

    function updateEditPathPreview() {
      const path = document.getElementById('editClassroomPath').value.trim();
      document.getElementById('editPathPreview').textContent = path || '___';
    }

    // ç›£è½è·¯å¾‘è¼¸å…¥è®ŠåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      const pathInput = document.getElementById('classroomPath');
      const editPathInput = document.getElementById('editClassroomPath');

      if (pathInput) {
        pathInput.addEventListener('input', updatePathPreview);
      }

      if (editPathInput) {
        editPathInput.addEventListener('input', updateEditPathPreview);
      }
    });

    function openEditClassroomModal(classroom) {
      editingClassroomId = classroom.id;
      document.getElementById('editClassroomName').value = classroom.name;
      document.getElementById('editClassroomPath').value = classroom.path;
      document.getElementById('editStudentNames').value = classroom.students.map(s => s.name).join('\n');
      document.getElementById('editClassroomModal').classList.add('active');
      updateEditPathPreview();
    }

    function closeEditClassroomModal() {
      document.getElementById('editClassroomModal').classList.remove('active');
      editingClassroomId = null;
    }

    async function saveClassroom() {
      const name = document.getElementById('editClassroomName').value.trim();
      const path = document.getElementById('editClassroomPath').value.trim();
      const studentNamesText = document.getElementById('editStudentNames').value.trim();

      if (!name) {
        alert('è«‹è¼¸å…¥æ•™å®¤åç¨±');
        return;
      }

      if (!path || !/^[a-zA-Z0-9\-_]+$/.test(path)) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è·¯å¾‘ï¼ˆåƒ…é™è‹±æ•¸å­—ã€é€£å­—è™Ÿã€åº•ç·šï¼‰');
        return;
      }

      if (!studentNamesText) {
        alert('è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹å­¸ç”Ÿå§“å');
        return;
      }

      const students = studentNamesText
        .split('\n')
        .map(s => s.trim())
        .filter(s => s.length > 0);

      if (students.length === 0) {
        alert('è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹å­¸ç”Ÿå§“å');
        return;
      }

      try {
        const response = await fetch(`/api/classrooms/${editingClassroomId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, path, students })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'æ›´æ–°æ•™å®¤å¤±æ•—');
        }

        closeEditClassroomModal();
      } catch (error) {
        console.error('æ›´æ–°æ•™å®¤å¤±æ•—:', error);
        alert(error.message || 'æ›´æ–°æ•™å®¤å¤±æ•—ï¼Œè«‹é‡è©¦');
      }
    }

    async function clearAllStatus(classroomId, classroomName) {
      if (!confirm(`ç¢ºå®šè¦æ¸…é™¤ã€Œ${classroomName}ã€æ‰€æœ‰å­¸ç”Ÿçš„ç‹€æ…‹å—ï¼Ÿ`)) {
        return;
      }

      try {
        const response = await fetch(`/api/classrooms/${classroomId}/clear`, {
          method: 'POST'
        });

        if (!response.ok) {
          throw new Error('æ¸…é™¤ç‹€æ…‹å¤±æ•—');
        }
      } catch (error) {
        console.error('æ¸…é™¤ç‹€æ…‹å¤±æ•—:', error);
        alert('æ¸…é™¤ç‹€æ…‹å¤±æ•—ï¼Œè«‹é‡è©¦');
      }
    }

    async function deleteClassroom(classroomId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ•™å®¤å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        return;
      }

      try {
        const response = await fetch(`/api/classrooms/${classroomId}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          throw new Error('åˆªé™¤æ•™å®¤å¤±æ•—');
        }
      } catch (error) {
        console.error('åˆªé™¤æ•™å®¤å¤±æ•—:', error);
        alert('åˆªé™¤æ•™å®¤å¤±æ•—ï¼Œè«‹é‡è©¦');
      }
    }

    async function createClassroom() {
      const name = document.getElementById('classroomName').value.trim();
      const path = document.getElementById('classroomPath').value.trim();
      const studentNamesText = document.getElementById('studentNames').value.trim();

      if (!name) {
        alert('è«‹è¼¸å…¥æ•™å®¤åç¨±');
        return;
      }

      if (!path || !/^[a-zA-Z0-9\-_]+$/.test(path)) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è·¯å¾‘ï¼ˆåƒ…é™è‹±æ•¸å­—ã€é€£å­—è™Ÿã€åº•ç·šï¼‰');
        return;
      }

      if (!studentNamesText) {
        alert('è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹å­¸ç”Ÿå§“å');
        return;
      }

      const students = studentNamesText
        .split('\n')
        .map(s => s.trim())
        .filter(s => s.length > 0);

      if (students.length === 0) {
        alert('è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹å­¸ç”Ÿå§“å');
        return;
      }

      try {
        const response = await fetch('/api/classrooms', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, path, students })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'å»ºç«‹æ•™å®¤å¤±æ•—');
        }

        closeAddClassroomModal();
      } catch (error) {
        console.error('å»ºç«‹æ•™å®¤å¤±æ•—:', error);
        alert(error.message || 'å»ºç«‹æ•™å®¤å¤±æ•—ï¼Œè«‹é‡è©¦');
      }
    }

    // åˆå§‹åŒ–
    async function init() {
      // å…ˆå¾ localStorage æ¢å¾©è³‡æ–™ä¸¦åŒæ­¥åˆ°ä¼ºæœå™¨
      await syncToServer();
      // ç„¶å¾Œé€£ç·š WebSocket
      connectWebSocket();
    }

    init();
  </script>
</body>

</html>